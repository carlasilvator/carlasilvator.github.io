<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø§Ø±Øª - Toxic Rose</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet" />
  <style>
           ;
      padding-left: 10px;
    }

    .comments b {
      color: #7dd3fc;
    }

    textarea {
      width: 100%;
      font-family: 'Amiri', serif;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #38bdf8;
      background: #020611;
      color: #cfefff;
      padding: 8px 10px;
      resize: vertical;
      min-height: 60px;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #7dd3fc;
    }

    button.send-comment {
      background: #0f172a;
      color: #7dd3fc;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Amiri', serif;
      transition: background-color 0.3s, color 0.3s;
    }

    button.send-comment:disabled {
      background: #334155;
      color: #7dd3fcaa;
      cursor: not-allowed;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }

    .nav-buttons a {
      background: var(--button-bg);
      color: var(--text-accent);
      padding: 10px 18px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .nav-buttons a:hover {
      background: var(--button-hover-bg);
    }

    /* Ø±Ø¯ÙˆØ¯ Ù…ØªØ¯Ø§Ø®Ù„Ø© */
    .comment-replies {
      margin-right: 20px;
      border-right: 2px solid #334155;
      padding-right: 12px;
      margin-top: 6px;
    }

    /* Ø²Ø± Ø§Ù„Ø±Ø¯ */
    .reply-btn {
      background: transparent;
      border: none;
      color: var(--link-color);
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 4px;
      text-decoration: underline;
    }

    /* Ø²Ø± Ø§Ù„ØªØµÙˆÙŠØª */
    .like-btn {
      background: transparent;
      border: none;
      color: var(--like-color);
      cursor: pointer;
      font-size: 1.2rem;
      margin-left: 10px;
      position: relative;
      user-select: none;
      transition: color 0.3s;
    }

    .like-btn.liked {
      color: #f87171;
      text-shadow: 0 0 6px #f87171;
    }

    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‚Ù„ÙˆØ¨ */
    .heart-effect {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      pointer-events: none;
      animation: heart-pop 0.7s forwards;
      transform-origin: center;
      z-index: 1000;
    }

  </style>
</head>

<body>
  <header>
    <div class="logo-wrapper">
      <img src="https://i.ibb.co/jkcmR2L0/Picsart-25-06-28-13-01-01-547.jpg" alt="Ø´Ø¹Ø§Ø± Ø¢Ø«ÙŠØ±ÙŠØ§Øª Ø§Ù„Ø¹Ù†Ù‚Ø§Ø¡" />
    </div>
  </header>

  <nav class="main-nav">
    <a href="index.html">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="https://www.instagram.com/carlasilvator" target="_blank">ğŸ“¸ Ø£Ù†Ø³ØªØºØ±Ø§Ù…ÙŠ</a>
    <a href="follow-me.html">ğŸ§¬ Ø§Ø´ØªØ±Ùƒ</a>
  </nav>

  <div class="container">
    <h2 class="story-title">Ø¨ÙŠÙ„Ø§Ø¯ÙˆÙ†Ø§ Ø§Ù„Ø³Ø§Ù…Ø©</h2>

    <div id="authButtons">
      <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>
      <button id="logoutBtn" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      <div id="userInfo"></div>
    </div>

    <div id="raw-content" style="display:none;">
~Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©~

Â«ÙƒØ§Ù†Øª Ù…Ø«Ù„ Ø§Ù„Ø¨ÙŠÙ„Ø§Ø¯ÙˆÙ†Ø§ ØªØ²Ù‡Ø± ÙÙŠ Ø§Ù„Ø¸Ù„Ø§Ù… Ù„ØªØºØ±ÙŠ Ø§Ù„Ù†Ø§Ø¸Ø±ÙŠÙ† Ø¨ÙØªÙ†Ø© Ø¬Ù…Ø§Ù„Ù‡Ø§ Ø§Ù„Ø³Ø§Ø­Ø± Ùˆ ØªØ®ÙÙŠ Ø¨ÙŠÙ† Ø·ÙŠØ§ØªÙ‡Ø§ Ø³Ù…Ù‡Ø§ Ø§Ù„Ù‚Ø§ØªÙ„ Ù…ÙˆÙ‚Ø¹Ø© Ø§Ù„ØªØ§Ø¦Ù‡ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ø±Ø¶ Ø§Ù„Ø¬Ù†ÙˆÙ† ÙÙŠ ÙØ®ÙˆØ®Ù‡Ø§ Ù…Ù†ØªØ¸Ø±Ø© ÙˆÙ‚Øª Ø£Ù‚Ø§Ù…Ø© Ø§Ù„Ø­Ø¯Ø§Ø¯ Ø¹Ù„Ù‰ Ø£Ø±ÙˆØ§Ø­Ù‡Ù… Ø§Ù„Ù…Ø¹Ø°Ø¨Ø© Ø¨Ø³Ù…ÙˆÙ…Ù‡Ø§Â»

...

(Ù†Øµ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)

</div>

    <div id="rendered-content"></div>

    <div id="read-count">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª: 0</div>

    <div class="nav-buttons">
      <a href="#" id="prevBtn">â¬…ï¸ Ø§Ù„Ø¨Ø§Ø±Øª Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
      <a href="#" id="nextBtn">Ø§Ù„Ø¨Ø§Ø±Øª Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</a>
    </div>
  </div>

  <footer style="text-align:center; padding:15px 0; color: #7dd3fc; font-family: 'Amiri', serif; font-size: 0.9rem;">
    Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Ù…Ø­ÙÙˆØ¸Ø©ØŒ ÙˆÙƒÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØºÙŠØ± Ù…Ø±Ø®Øµ ÙŠØ¹Ø±Ø¶ ØµØ§Ø­Ø¨Ù‡ Ù„Ù„Ù…Ø³Ø§Ø¡Ù„Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© â€” &copy; 2025
  </footer>

  <div id="notification-area"></div>

  <!-- Firebase & Comments Logic -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtTc7yWNfNkG0oVSbpq0V9A6DHTgZoGBM",
      authDomain: "works-rawan.firebaseapp.com",
      projectId: "works-rawan",
      storageBucket: "works-rawan.firebasestorage.app",
      messagingSenderId: "986254083746",
      appId: "1:986254083746:web:17f7db0389c94473f0b9fb"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");
    const notificationArea = document.getElementById("notification-area");
    const readCountElem = document.getElementById("read-count");

    let currentUser = null;
    const partId = "toxic-part-1";

    // --- Authentication ---
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        userInfo.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName || user.email}`;
        listenForNotifications(user.uid);
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        userInfo.textContent = "";
        clearNotificationListener();
      }
      // Update send buttons enable/disable on auth change
      updateAllSendButtons();
      updateAllLikeButtons();
    });

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    };

    logoutBtn.onclick = () => auth.signOut();

    function sanitize(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±Øª (Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ---
    async function incrementReadCount() {
      const partRef = db.collection("parts").doc(partId);
      await db.runTransaction(async (t) => {
        const doc = await t.get(partRef);
        if (!doc.exists) {
          t.set(partRef, { readCount: 1, likesCount: 0, likedBy: [] });
        } else {
          const current = doc.data().readCount || 0;
          t.update(partRef, { readCount: current + 1 });
        }
      });
      updateReadCountUI();
    }

    async function updateReadCountUI() {
      const partRef = db.collection("parts").doc(partId);
      const doc = await partRef.get();
      const count = (doc.exists && doc.data().readCount) || 0;
      readCountElem.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª: ${count}`;
    }

    // --- Render Ø§Ù„ÙÙ‚Ø±Ø§Øª + ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ + Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙˆÙŠØª ---
    function renderParagraphs(partId = 'toxic-part-1') {
      const rawContent = document.getElementById('raw-content').textContent.trim();
      const paragraphs = rawContent.split(/\n\s*\n/);
      const container = document.getElementById('rendered-content');
      container.innerHTML = '';

      paragraphs.forEach((text, index) => {
        const paraId = `${partId}-p-${index + 1}`;
        const paraDiv = document.createElement('div');
        paraDiv.className = 'paragraph';
        paraDiv.id = paraId;

        const p = document.createElement('p');
        p.innerHTML = sanitize(text.trim());
        paraDiv.appendChild(p);

        // Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯
        const commentBtn = document.createElement('button');
        commentBtn.textContent = 'ğŸ’¬';
        commentBtn.style.cssText = 'margin-top:10px;background:transparent;border:none;color:#38bdf8;font-size:18px;cursor:pointer';
        commentBtn.onclick = () => toggleCommentBox(paraId);
        paraDiv.appendChild(commentBtn);

        // Ø²Ø± Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„ÙÙ‚Ø±Ø© Ù†ÙØ³Ù‡Ø§ (Ù„Ùˆ Ø­Ø§Ø¨Ø¨) - Ø£Ùˆ Ù†Ø·Ø¨Ù‚ Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙÙ‚Ø·ØŒ Ù‡ÙˆÙ† Ø¨Ù†Ø·Ø¨Ù‚ Ù„Ù„Ø¨Ø§Ø±Øª ÙƒÙƒÙ„.
        // Ù…Ù…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØµÙˆÙŠØª Ø¹Ø§Ù… Ù„Ù„Ø¨Ø§Ø±Øª Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ.

        // ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        const commentBox = document.createElement('div');
        commentBox.className = 'comment-box';
        commentBox.id = `box-${paraId}`;
        commentBox.style.display = 'none';

        // Ù…ÙƒØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        const commentsDiv = document.createElement('div');
        commentsDiv.className = 'comments';
        commentBox.appendChild(commentsDiv

        // Ù…ÙƒØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        const commentsDiv = document.createElement('div');
        commentsDiv.className = 'comments';
        commentBox.appendChild(commentsDiv);

        // Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        const textarea = document.createElement('textarea');
        textarea.placeholder = 'Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§...';
        commentBox.appendChild(textarea);

        // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        const sendBtn = document.createElement('button');
        sendBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„';
        sendBtn.className = 'send-comment';
        sendBtn.disabled = !currentUser;
        sendBtn.onclick = () => sendComment(paraId, textarea.value, null, commentsDiv, textarea, sendBtn);
        commentBox.appendChild(sendBtn);

        paraDiv.appendChild(commentBox);

        container.appendChild(paraDiv);

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙÙ‚Ø±Ø©
        loadComments(paraId, commentsDiv);

      });
    }

    // ØªÙØ¹ÙŠÙ„/Ø¥Ø®ÙØ§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    function toggleCommentBox(paraId) {
      const box = document.getElementById(`box-${paraId}`);
      if (!box) return;
      if (box.style.display === 'none') {
        box.style.display = 'block';
      } else {
        box.style.display = 'none';
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ù† Firebase Ù…Ø¹ Ø±Ø¯ÙˆØ¯ Ù…ØªØ¯Ø§Ø®Ù„Ø© (up to 4 replies)
    async function loadComments(paraId, container) {
      container.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p>';

      try {
        const commentsSnapshot = await db.collection("comments")
          .where("partId", "==", partId)
          .where("paragraphId", "==", paraId)
          .where("parentId", "==", null)
          .orderBy("createdAt", "asc")
          .get();

        if (commentsSnapshot.empty) {
          container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</p>';
          return;
        }

        container.innerHTML = '';
        commentsSnapshot.forEach(doc => {
          const data = doc.data();
          const commentElem = createCommentElement(doc.id, data, 0);
          container.appendChild(commentElem);
        });

      } catch (err) {
        container.innerHTML = `<p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª.</p>`;
        console.error(err);
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ØªØ¹Ù„ÙŠÙ‚ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø© (Ø­ØªÙ‰ 4 ÙÙ‚Ø·)
    function createCommentElement(commentId, data, level) {
      const div = document.createElement('div');
      div.style.marginRight = `${level * 20}px`;
      div.style.marginTop = '8px';
      div.style.borderRight = level > 0 ? '2px solid #334155' : 'none';
      div.style.paddingRight = '10px';

      const author = document.createElement('b');
      author.textContent = sanitize(data.authorName || 'Ù…Ø¬Ù‡ÙˆÙ„');
      div.appendChild(author);

      const text = document.createElement('p');
      text.style.margin = '4px 0 4px 0';
      text.innerHTML = sanitize(data.text);
      div.appendChild(text);

      // Ø²Ø± Ø§Ù„Ø±Ø¯
      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Ø±Ø¯';
      replyBtn.className = 'reply-btn';
      replyBtn.onclick = () => openReplyBox(commentId, div, level);
      div.appendChild(replyBtn);

      // Ù‚Ø³Ù… Ø§Ù„Ø±Ø¯ÙˆØ¯
      const repliesDiv = document.createElement('div');
      repliesDiv.className = 'comment-replies';
      div.appendChild(repliesDiv);

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ (Ø­ØªÙ‰ 4 ÙÙ‚Ø·)
      db.collection("comments")
        .where("parentId", "==", commentId)
        .orderBy("createdAt", "asc")
        .limit(4)
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const replyData = doc.data();
            const replyElem = createCommentElement(doc.id, replyData, level + 1);
            repliesDiv.appendChild(replyElem);
          });

          // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ø¥Ø°Ø§ ÙÙŠ Ø±Ø¯ÙˆØ¯ Ø£ÙƒØ«Ø±
          db.collection("comments")
            .where("parentId", "==", commentId)
            .get()
            .then(allReplies => {
              if (allReplies.size > 4) {
                const moreBtn = document.createElement('button');
                moreBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
                moreBtn.className = 'reply-btn';
                moreBtn.style.marginTop = '4px';
                moreBtn.onclick = () => {
                  moreBtn.style.display = 'none';
                  loadMoreReplies(commentId, repliesDiv, level + 1, 4);
                };
                div.appendChild(moreBtn);
              }
            });
        });

      return div;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø±Ø¯ÙˆØ¯ (pagination)
    function loadMoreReplies(parentId, container, level, offset) {
      db.collection("comments")
        .where("parentId", "==", parentId)
        .orderBy("createdAt", "asc")
        .startAfter(offset)
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            const elem = createCommentElement(doc.id, data, level);
            container.appendChild(elem);
          });
        });
    }

    // ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚ Ù…Ø¹ÙŠÙ†
    function openReplyBox(parentId, parentElem, level) {
      // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
      if (parentElem.querySelector('.reply-box')) return;

      const replyBox = document.createElement('div');
      replyBox.className = 'comment-box reply-box';
      replyBox.style.marginTop = '6px';

      const textarea = document.createElement('textarea');
      textarea.placeholder = 'Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§...';
      replyBox.appendChild(textarea);

      const sendBtn = document.createElement('button');
      sendBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯';
      sendBtn.className = 'send-comment';
      sendBtn.disabled = !currentUser;
      sendBtn.onclick = () => {
        const text = textarea.value.trim();
        if (!text) return alert('Ø§Ù„Ø±Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹');
        sendReply(parentId, text, replyBox, sendBtn, parentElem);
      };
      replyBox.appendChild(sendBtn);

      parentElem.appendChild(replyBox);
    }

    // Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
    async function sendComment(paraId, text, parentId = null, commentsDiv, textarea, sendBtn) {
      if (!currentUser) {
        alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      text = text.trim();
      if (!text) {
        alert('Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.');
        return;
      }

      sendBtn.disabled = true;

      try {
        await db.collection("comments").add({
          partId: partId,
          paragraphId: paraId,
          parentId: parentId,
          authorId: currentUser.uid,
          authorName: currentUser.displayName || currentUser.email,
          text: text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        textarea.value = '';
        loadComments(paraId, commentsDiv);
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚.');
        console.error(err);
      }

      sendBtn.disabled = false;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯
    async function sendReply(parentId, text, replyBox, sendBtn, parentElem) {
      if (!currentUser) {
        alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      text = text.trim();
      if (!text) {
        alert('Ø§Ù„Ø±Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.');
        return;
      }

      sendBtn.disabled = true;

      try {
        await db.collection("comments").add({
          partId: partId,
          paragraphId: null,
          parentId: parentId,
          authorId: currentUser.uid,
          authorName: currentUser.displayName || currentUser.email,
          text: text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        replyBox.remove();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„ÙÙ‚Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        const paraId = document.getElementById(parentElem.id).id || null;
        if (paraId) {
          const paraDiv = document.getElementById(paraId);
          const box = paraDiv ? document.getElementById(`box-${paraId}`) : null;
          if (box) {
            const commentsDiv = box.querySelector('.comments');
            loadComments(paraId, commentsDiv);
          }
        }
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯.');
        console.error(err);
      }

      sendBtn.disabled = false;

      // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ (Ù„Ùˆ Ù…Ø´ Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ)
      notifyOriginalAuthor(parentId, currentUser.uid, text);
    }

    // --- Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±Øª ---
    const likeBtn = document.createElement('button');
    likeBtn.className = 'like-btn';
    likeBtn.title = 'ØµÙˆÙ‘Øª Ù„Ù„Ø¨Ø§Ø±Øª';
    likeBtn.innerHTML = 'â¤';
    likeBtn.style.fontSize = '28px';
    likeBtn.style.marginTop = '20px';
    likeBtn.style.display = 'block';
    likeBtn.style.marginLeft = 'auto';
    likeBtn.style.marginRight = 'auto';
    likeBtn.disabled = true; // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¹Ø·Ù„ Ø­ØªÙ‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„

    document.querySelector('.container').appendChild(likeBtn);

    likeBtn.onclick = async () => {
      if (!currentUser) return alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
      await toggleLike();
    };

    async function toggleLike() {
      const partRef = db.collection("parts").doc(partId);
      const doc = await partRef.get();
      if (!doc.exists) {
        await partRef.set({
          likesCount: 0,
          likedBy: []
        });
      }

      const data = (await partRef.get()).data();
      let likedBy = data.likedBy || [];
      const userIndex = likedBy.indexOf(currentUser.uid);

      if (userIndex === -1) {
        likedBy.push(currentUser.uid);
        likeBtn.classList.add('liked');
        createHeartEffect(likeBtn);
      } else {
        likedBy.splice(userIndex, 1);
        likeBtn.classList.remove('liked');
      }

      await partRef.update({
        likedBy: likedBy,
        likesCount: likedBy.length
      });

      updateLikeUI(likedBy.length);
    }

    async function updateLikeUI(count) {
      // Ù†Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµÙˆØªÙŠÙ† Ø£Ø³ÙÙ„ Ø§Ù„Ø²Ø± Ø£Ùˆ Ù…ÙƒØ§Ù† Ù…Ø®ØµØµ
      if (!document.getElementById('likes-count')) {
        const likeCountElem = document.createElement('div');
        likeCountElem.id = 'likes-count';
        likeCountElem.style.color = '#f87171';
        likeCountElem.style.textAlign = 'center';
        likeCountElem.style.marginTop = '6px';
        document.querySelector('.container').appendChild(likeCountElem);
      }
      document.getElementById('likes-count').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµÙˆØªÙŠÙ†: ${count}`;
    }

    function createHeartEffect(button) {
      const heart = document.createElement('span');
      heart.className = 'heart-effect';
      heart.textContent = 'â¤';
      const rect = button.getBoundingClientRect();
      heart.style.top = '50%';
      heart.style.left = '50%';
      button.appendChild(heart);
      setTimeout(() => heart.remove(), 700);
    }

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªØµÙˆÙŠØª Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬
    function updateAllSendButtons() {
      const sendBtns = document.querySelectorAll('.send-comment');
      sendBtns.forEach(btn => {
        btn.disabled = !currentUser;
      });
    }

    function updateAllLikeButtons() {
      likeBtn.disabled = !currentUser;
      if (!currentUser) likeBtn.classList.remove('liked');
    }

    // --- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ ---
    let notificationsListenerUnsubscribe = null;

    function listenForNotifications(uid) {
      if (notificationsListenerUnsubscribe) notificationsListenerUnsubscribe();

      notificationsListenerUnsubscribe = db.collection("notifications")
        .where("userId", "==", uid)
        .where("read", "==", false)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              const notif = change.doc.data();
              showNotification(notif.message);
              // Ø¹Ù„Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø£Ù†Ù‡ Ù…Ù‚Ø±ÙˆØ¡
              db.collection("notifications").doc(change.doc.id).update({ read: true });
            }
          });
        });
    }

    function clearNotificationListener() {
      if (notificationsListenerUnsubscribe) {
        notificationsListenerUnsubscribe();
        notificationsListenerUnsubscribe = null;
      }
    }

    function showNotification(message) {
      notificationArea.textContent = message;
      notificationArea.style.display = 'block';
      setTimeout(() => {
        notificationArea.style.display = 'none';
      }, 6000);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯
    async function notifyOriginalAuthor(commentId, replierUid, replyText) {
      try {
        const commentDoc = await db.collection("comments").doc(commentId).get();
        if (!commentDoc.exists) return;

        const commentData = commentDoc.data();
        const originalAuthorUid = commentData.authorId;

        if (!originalAuthorUid || originalAuthorUid === replierUid) return; // Ù„Ø§ ØªÙ†Ø¨Ù‡ Ù†ÙØ³Ùƒ!

        const message = `Ù„Ø¯ÙŠÙƒ Ø±Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚Ùƒ: "${replyText.slice(0, 50)}..."`;

        await db.collection("notifications").add({
          userId: originalAuthorUid,
          message: message,
          read: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', err);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ ØªØ¬Ø²Ø¦Ø© Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø§Øª Ù…Ø¹ ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ²Ø± ØªØ¹Ù„ÙŠÙ‚ Ù„ÙƒÙ„ ÙÙ‚Ø±Ø©
    function init() {
      renderParagraphs();
      incrementReadCount();
      updateReadCountUI();
      updateLikeUI(0);
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = () => {
      init();
    };

  </script>
</body>
</html>                             
