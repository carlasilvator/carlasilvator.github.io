<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>بارت مع تسجيل دخول إيميل</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { background: #121212; color: #eee; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
    input, button, textarea { margin: 5px 0; padding: 8px; width: 100%; max-width: 400px; border-radius: 4px; border: none; }
    button { cursor: pointer; background: #444; color: #eee; }
    .paragraph { margin-bottom: 30px; }
    .comments-section { margin-top: 10px; border: 1px solid #555; padding: 10px; display: none; }
    .comment { background: #222; color: #eee; margin: 5px 0; padding: 5px; border-radius: 4px; display: flex; justify-content: space-between; }
    .comment button { background: transparent; border: none; color: #f55; cursor: pointer; }
  </style>
</head>
<body>

<h2>بارت مع تعليقات + تسجيل دخول بالإيميل</h2>

<div id="authSection">
  <input type="email" id="email" placeholder="الإيميل" />
  <input type="password" id="password" placeholder="كلمة السر" />
  <button id="signUpBtn">سجل حساب جديد</button>
  <button id="signInBtn">تسجيل دخول</button>
  <button id="signOutBtn" style="display:none;">تسجيل خروج</button>
  <div id="userInfo" style="margin-top:10px;"></div>
</div>

<div class="paragraph" id="para-1">
  <p>نص الفقرة الأولى من البارت...</p>
  <button onclick="toggleComments('para-1')">تعليقات</button>
  <div class="comments-section" id="comments-para-1">
    <div class="comments-list"></div>
    <textarea placeholder="اكتب تعليقك هنا..." disabled></textarea>
    <button onclick="submitComment('para-1')" disabled>أرسل</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBtTc7yWNfNkG0oVSbpq0V9A6DHTgZoGBM",
    authDomain: "works-rawan.firebaseapp.com",
    projectId: "works-rawan",
    storageBucket: "works-rawan.firebasestorage.app",
    messagingSenderId: "986254083746",
    appId: "1:986254083746:web:17f7db0389c94473f0b9fb"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signUpBtn = document.getElementById('signUpBtn');
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const userInfo = document.getElementById('userInfo');

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user) {
      userInfo.textContent = `مرحباً، ${user.email}`;
      signOutBtn.style.display = 'block';
      signInBtn.style.display = 'none';
      signUpBtn.style.display = 'none';
      enableCommentBoxes(true);
    } else {
      userInfo.textContent = '';
      signOutBtn.style.display = 'none';
      signInBtn.style.display = 'block';
      signUpBtn.style.display = 'block';
      enableCommentBoxes(false);
    }
  });

  signUpBtn.onclick = () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if(!email || !password) return alert('املأ الحقول');
    auth.createUserWithEmailAndPassword(email, password)
      .catch(e => alert('خطأ بالتسجيل: ' + e.message));
  };

  signInBtn.onclick = () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if(!email || !password) return alert('املأ الحقول');
    auth.signInWithEmailAndPassword(email, password)
      .catch(e => alert('خطأ بتسجيل الدخول: ' + e.message));
  };

  signOutBtn.onclick = () => {
    auth.signOut();
  };

  function enableCommentBoxes(enable) {
    const textareas = document.querySelectorAll('.comments-section textarea');
    const buttons = document.querySelectorAll('.comments-section button');
    textareas.forEach(ta => ta.disabled = !enable);
    buttons.forEach(btn => btn.disabled = !enable);
  }

  function toggleComments(paraId) {
    const section = document.getElementById('comments-' + paraId);
    if (section.style.display === 'none') {
      section.style.display = 'block';
      loadComments(paraId);
    } else {
      section.style.display = 'none';
    }
  }

  function loadComments(paraId) {
    const commentsList = document.querySelector(`#comments-${paraId} .comments-list`);
    commentsList.innerHTML = 'جاري التحميل...';

    db.collection("comments")
      .where("paragraphId", "==", paraId)
      .orderBy("timestamp", "asc")
      .get()
      .then(querySnapshot => {
        commentsList.innerHTML = '';
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement('div');
          div.className = 'comment';

          const spanText = document.createElement('span');
          spanText.textContent = data.text;
          div.appendChild(spanText);

          if(currentUser && data.userId === currentUser.uid) {
            const delBtn = document.createElement('button');
            delBtn.textContent = 'حذف';
            delBtn.onclick = () => {
              if(confirm('هل تريد حذف هذا التعليق؟')) {
                db.collection('comments').doc(doc.id).delete();
                loadComments(paraId);
              }
            };
            div.appendChild(delBtn);

            const editBtn = document.createElement('button');
            editBtn.textContent = 'تعديل';
            editBtn.style.marginLeft = '10px';
            editBtn.onclick = () => {
              const newText = prompt('عدّل تعليقك:', data.text);
              if(newText !== null && newText.trim() !== '') {
                db.collection('comments').doc(doc.id).update({ text: newText.trim() });
                loadComments(paraId);
              }
            };
            div.appendChild(editBtn);
          }

          commentsList.appendChild(div);
        });
      })
      .catch(error => {
        commentsList.innerHTML = 'خطأ بتحميل التعليقات';
      });
  }

  function submitComment(paraId) {
    const textarea = document.querySelector(`#comments-${paraId} textarea`);
    const text = textarea.value.trim();
    if (text === '') {
      alert('اكتب تعليق قبل الإرسال');
      return;
    }
    if(!currentUser) {
      alert('لازم تسجل الدخول لتكتب تعليق');
      return;
    }
    db.collection("comments").add({
      paragraphId: paraId,
      text: text,
      userId: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      textarea.value = '';
      loadComments(paraId);
    })
    .catch(() => {
      alert('خطأ بإنشاء التعليق');
    });
  }
</script>

</body>
  </html>
