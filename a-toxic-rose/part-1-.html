<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>بارت 1 - A Toxic Rose</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { background: #121212; color: #eee; font-family: sans-serif; padding: 20px; }
    .paragraph { margin-bottom: 30px; }
    .comments-section { margin-top: 10px; border: 1px solid #555; padding: 10px; display: none; }
    .comment { background: #222; color: #eee; margin: 5px 0; padding: 5px; border-radius: 4px; display: flex; justify-content: space-between; }
    .comment button { background: transparent; border: none; color: #f55; cursor: pointer; }
    textarea { width: 100%; height: 60px; }
    button { margin-top: 5px; cursor: pointer; }
    #authButtons button { margin-left: 10px; }
  </style>
</head>
<body>

  <h2>بارت 1 - A Toxic Rose</h2>

  <div id="authButtons">
    <button id="loginBtn">تسجيل الدخول بـ Google</button>
    <button id="logoutBtn" style="display:none;">تسجيل الخروج</button>
    <span id="userInfo" style="margin-right: 15px;"></span>
  </div>

  <!-- الفقرة الأولى -->
  <div class="paragraph" id="para-1">
    <p>كان الحقل هادئًا... أكثر مما يجب.</p>
    <button onclick="toggleComments('para-1')">تعليقات</button>
    <div class="comments-section" id="comments-para-1">
      <div class="comments-list"></div>
      <textarea placeholder="اكتب تعليقك هنا..." disabled></textarea>
      <button onclick="submitComment('para-1')" disabled>أرسل</button>
    </div>
  </div>

  <!-- الفقرة الثانية -->
  <div class="paragraph" id="para-2">
    <p>وحين خطا خطوة واحدة... تغيّر كل شيء.</p>
    <button onclick="toggleComments('para-2')">تعليقات</button>
    <div class="comments-section" id="comments-para-2">
      <div class="comments-list"></div>
      <textarea placeholder="اكتب تعليقك هنا..." disabled></textarea>
      <button onclick="submitComment('para-2')" disabled>أرسل</button>
    </div>
  </div>

<script>
  // إعدادات Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBtTc7yWNfNkG0oVSbpq0V9A6DHTgZoGBM",
    authDomain: "works-rawan.firebaseapp.com",
    projectId: "works-rawan",
    storageBucket: "works-rawan.firebasestorage.app",
    messagingSenderId: "986254083746",
    appId: "1:986254083746:web:17f7db0389c94473f0b9fb"
  };

  // تهيئة Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userInfo = document.getElementById('userInfo');

  // تسجيل الدخول
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  };

  // تسجيل الخروج
  logoutBtn.onclick = () => auth.signOut();

  // مراقبة حالة المستخدم
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      userInfo.textContent = `مرحباً، ${user.displayName}`;
      enableCommentBoxes(true);
    } else {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      userInfo.textContent = '';
      enableCommentBoxes(false);
    }
  });

  function enableCommentBoxes(enable) {
    const textareas = document.querySelectorAll('.comments-section textarea');
    const buttons = document.querySelectorAll('.comments-section button');
    textareas.forEach(t => t.disabled = !enable);
    buttons.forEach(b => b.disabled = !enable);
  }

  function toggleComments(paraId) {
    const section = document.getElementById(`comments-${paraId}`);
    if (section.style.display === 'none') {
      section.style.display = 'block';
      loadComments(paraId);
    } else {
      section.style.display = 'none';
    }
  }

  function loadComments(paraId) {
    const list = document.querySelector(`#comments-${paraId} .comments-list`);
    list.innerHTML = 'جاري التحميل...';

    db.collection("comments")
      .where("paragraphId", "==", paraId)
      .orderBy("timestamp", "asc")
      .get()
      .then(snapshot => {
        list.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement('div');
          div.className = 'comment';
          const span = document.createElement('span');
          span.textContent = data.text;
          div.appendChild(span);

          if (currentUser && data.userId === currentUser.uid) {
            const delBtn = document.createElement('button');
            delBtn.textContent = 'حذف';
            delBtn.onclick = () => {
              if (confirm('هل تريد حذف هذا التعليق؟')) {
                db.collection('comments').doc(doc.id).delete().then(() => loadComments(paraId));
              }
            };
            div.appendChild(delBtn);

            const editBtn = document.createElement('button');
            editBtn.textContent = 'تعديل';
            editBtn.style.marginLeft = '10px';
            editBtn.onclick = () => {
              const newText = prompt('عدّل تعليقك:', data.text);
              if (newText && newText.trim() !== '') {
                db.collection('comments').doc(doc.id).update({ text: newText.trim() }).then(() => loadComments(paraId));
              }
            };
            div.appendChild(editBtn);
          }

          list.appendChild(div);
        });
      })
      .catch(() => {
        list.innerHTML = 'فشل في تحميل التعليقات.';
      });
  }

  function submitComment(paraId) {
    const textarea = document.querySelector(`#comments-${paraId} textarea`);
    const text = textarea.value.trim();
    if (!text) return alert('اكتب تعليق قبل الإرسال');
    if (!currentUser) return alert('سجّل الدخول أولاً');

    db.collection("comments").add({
      paragraphId: paraId,
      text: text,
      userId: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      textarea.value = '';
      loadComments(paraId);
    })
    .catch(() => alert('حدث خطأ أثناء إرسال التعليق'));
  }
</script>

</body>
</html>
